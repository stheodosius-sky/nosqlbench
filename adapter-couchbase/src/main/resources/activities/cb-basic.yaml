# nb -v run driver=couchbase yaml=couchbase-basic connection=couchbase://127.0.0.1 bucket=testdb tags=phase:rampup cycles=1M
description: An example of a basic couchbase insert and retrieve.

scenarios:
  default:
    - run driver=couchbase tags==phase:rampup cycles===100000 threads=auto
    - run driver=couchbase tags==phase:main cycles===100000 threads=auto

bindings:
  seq_key: Mod(<<keyCount:1000000>>L); ToInt()
  seq_value: Mod(<<valueCount:1000000000>>L); <<valueSizeDist:Hash()>>; ToString() -> String
  rw_key: <<keyDist:Uniform(0,1000000)->long>>; ToInt()
  rw_value: <<valDist:Uniform(0,1000000000)->int>>; <<valueSizeDist:Hash()>>; ToString() -> String

params:
  scope: <<scope:_default>>
  collection: <<collection:_default>>

blocks:
  - name: rampup
    tags:
      phase: rampup
    ops:
      rampup-upsert:
        upsert: "{seq_key}"
        content: |
          {
            "key": "{seq_value}"
          }
  - name: main-read
    tags:
      phase: main
      type: read
    params:
      ratio: <<read_ratio:1>>
    ops:
      main-retrieve:
        retrieve: "{rw_key}"
  - name: main-write
    tags:
      phase: main
      type: write
    params:
      ratio: <<write_ratio:1>>
#      expiry: 5m
#      durability: PERSIST_TO_MAJORITY
    ops:
      main-upsert:
        upsert: "{rw_key}"
        content: |
          {
            "key": "{rw_value}"
          }
  - name: main-remove
    tags:
      phase: main
      type: write
    params:
      ratio: <<remove_ratio:1>>
    ops:
      main-remove:
        remove: "{rw_key}"
